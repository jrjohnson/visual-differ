name: Visual Diff

on:
  pull_request: {}

concurrency:
  group: visual-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  baseline:
    name: Baseline
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install
      - run: pnpm exec playwright install --with-deps
      - name: Capture Screenshots
        run: pnpm run test:screenshots
      - uses: actions/upload-artifact@v6
        with:
          name: baseline
          path: build

  candidate:
    name: Candidate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install
      - run: pnpm exec playwright install --with-deps
      - name: Capture Screenshots
        run: pnpm run test:screenshots
      - uses: actions/upload-artifact@v6
        with:
          name: candidate
          path: build

  compare:
    name: Visual Diff
    needs: [baseline, candidate]
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: visual-diff-${{ github.event.pull_request.number }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
      - run: ls -lh baseline candidate
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - run: pnpm install
      - run: pnpm build
      - run: |
          mkdir -p ./results
          echo ${{ github.event.pull_request.number }} > ./results/pr_number
      - name: Create Visual Diff
        run: node ./dist/bin/visual-differ.js baseline candidate ${{ env.OUTPUT_DIR }} > results/visual-diff.txt
      - if: always()
        run: cp ${{ env.OUTPUT_DIR }}/report.md results/
      - if: always()
        run: cat results/report.md results/visual-diff.txt
      - uses: actions/upload-artifact@v6
        id: upload-output
        if: always()
        with:
          name: ${{ env.OUTPUT_DIR }}
          path: ${{ env.OUTPUT_DIR }}
      - if: always()
        run: echo ${{ steps.upload-output.outputs.artifact-url }} > ./results/artifact_url
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: results
          path: results
