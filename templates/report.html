<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visual Diff Report</title>
    <style>
      .diff-images {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
      }
      .diff-images img {
        max-width: 30vw;
        height: auto;
      }
      details {
        margin-bottom: 1em;
      }
      summary {
        cursor: pointer;
        font-size: 1.17em;
        font-weight: bold;
      }

      .lightbox-trigger {
        all: unset;
        cursor: zoom-in;
        border-radius: 4px;
        outline: 2px solid transparent;
        outline-offset: 2px;
        transition: outline-color 0.15s;

        &:hover,
        &:focus-visible {
          outline-color: Highlight;
        }

        & img {
          display: block;
          border-radius: inherit;
        }
      }

      #lightbox {
        &[open] {
          position: fixed;
          inset: 0;
          width: 100dvw;
          height: 100dvh;
          max-width: none;
          max-height: none;
          margin: 0;
          padding: 0;
          border: none;
          background: none;
          display: grid;
          place-items: center;
          overflow: auto;
          animation: lightbox-fade-in 0.15s ease-out;
        }

        &::backdrop {
          background: rgb(0 0 0 / 0.92);
          animation: lightbox-fade-in 0.15s ease-out;
        }
      }

      @keyframes lightbox-fade-in {
        from {
          opacity: 0;
        }
      }

      .lightbox-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }

      .lightbox-image {
        max-height: calc(100dvh - 4rem);
        object-fit: contain;
        border-radius: 4px;
      }

      .lightbox-caption {
        color: rgb(255 255 255 / 0.9);
        font:
          0.875rem/1.4 system-ui,
          sans-serif;
        text-align: center;
        margin: 0;
      }

      .lightbox-counter {
        color: rgb(255 255 255 / 0.5);
        font:
          0.75rem/1 system-ui,
          sans-serif;
      }

      .lightbox-link {
        color: rgb(255 255 255 / 0.7);
        font:
          0.75rem/1 system-ui,
          sans-serif;
        text-decoration: none;
        padding: 0.25rem 0.75rem;
        border: 1px solid rgb(255 255 255 / 0.3);
        border-radius: 4px;
        transition:
          color 0.15s,
          border-color 0.15s;

        &:hover,
        &:focus-visible {
          color: white;
          border-color: white;
        }
      }

      .lightbox-btn {
        appearance: none;
        border: none;
        background: rgb(255 255 255 / 0.1);
        color: white;
        cursor: pointer;
        border-radius: 50%;
        display: grid;
        place-items: center;
        transition: background-color 0.15s;

        &:hover {
          background: rgb(255 255 255 / 0.25);
        }

        &:focus-visible {
          outline: 2px solid white;
          outline-offset: 2px;
        }
      }

      .lightbox-close {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 2.5rem;
        height: 2.5rem;
      }

      .lightbox-nav {
        position: fixed;
        top: 50%;
        translate: 0 -50%;
        width: 3rem;
        height: 3rem;

        &[hidden] {
          display: none;
        }
      }

      .lightbox-prev {
        left: 1rem;
      }
      .lightbox-next {
        right: 1rem;
      }

      .lightbox-icon {
        width: 1.25rem;
        height: 1.25rem;
        fill: none;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Visual Diff Report</h1>
      <p><strong>Status:</strong> <span aria-hidden="true">{{statusEmoji}}</span> {{statusText}}</p>
      <h2>Summary</h2>
      <ul>
        <li><strong>Total Images:</strong> {{totalImages}}</li>
        <li><strong>Different:</strong> {{diffCount}}</li>
        <li><strong>Removed:</strong> {{removedCount}}</li>
        <li><strong>Added:</strong> {{addedCount}}</li>
        <li><strong>Identical:</strong> {{identicalCount}}</li>
      </ul>

      {{#if withDifferences.length}}
      <h2>Images with Differences ({{withDifferences.length}})</h2>
      {{#each withDifferences}}
      <div>
        <h3>{{name}}</h3>
        {{#if dimensionMismatch}}
        <p>
          <strong><span aria-label="Warning">⚠️</span> Dimension mismatch:</strong> Baseline
          {{dimensionMismatch.baseline}}, Candidate {{dimensionMismatch.candidate}}
        </p>
        {{else}}
        <p><strong>Difference:</strong> {{diffPercentage}}%</p>
        {{/if}}
        <div class="diff-images">
          <button type="button" class="lightbox-trigger">
            <img src="{{baselineImage}}" alt="Baseline screenshot for {{name}}" />
          </button>
          {{#unless dimensionMismatch}}
          <button type="button" class="lightbox-trigger">
            <img
              src="{{diffImage}}"
              alt="Visual difference highlighting changed pixels in {{name}}"
            />
          </button>
          {{/unless}}
          <button type="button" class="lightbox-trigger">
            <img src="{{candidateImage}}" alt="Candidate screenshot for {{name}}" />
          </button>
        </div>
      </div>
      {{/each}} {{/if}} {{#if hasRemovedOrAdded}}
      <h2>Missing or New Files</h2>
      {{#if baselineOnly.length}}
      <details>
        <summary>Removed from Candidate ({{baselineOnly.length}})</summary>
        <ul>
          {{#each baselineOnly}}
          <li>{{name}}</li>
          {{/each}}
        </ul>
      </details>
      {{/if}} {{#if candidateOnly.length}}
      <details>
        <summary>Added in Candidate ({{candidateOnly.length}})</summary>
        <ul>
          {{#each candidateOnly}}
          <li>{{name}}</li>
          {{/each}}
        </ul>
      </details>
      {{/if}} {{/if}} {{#if withoutDifferences.length}}
      <details>
        <summary>Identical Images ({{withoutDifferences.length}})</summary>
        <ul>
          {{#each withoutDifferences}}
          <li>{{name}}</li>
          {{/each}}
        </ul>
      </details>
      {{/if}}

      <hr />
      <p><em>Generated by visual-differ</em></p>
    </main>

    <dialog id="lightbox" aria-label="Image viewer">
      <button type="button" class="lightbox-btn lightbox-close" aria-label="Close">
        <svg class="lightbox-icon" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <button
        type="button"
        class="lightbox-btn lightbox-nav lightbox-prev"
        aria-label="Previous image"
      >
        <svg class="lightbox-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6" /></svg>
      </button>
      <button type="button" class="lightbox-btn lightbox-nav lightbox-next" aria-label="Next image">
        <svg class="lightbox-icon" viewBox="0 0 24 24"><polyline points="9 6 15 12 9 18" /></svg>
      </button>
      <div class="lightbox-panel">
        <img class="lightbox-image" src="" alt="" />
        <p class="lightbox-caption"></p>
        <span class="lightbox-counter"></span>
        <a class="lightbox-link" href="" target="_blank" rel="noopener">Open image</a>
      </div>
    </dialog>

    <script>
      (() => {
        const lightbox = document.querySelector('#lightbox');
        const image = lightbox.querySelector('.lightbox-image');
        const caption = lightbox.querySelector('.lightbox-caption');
        const counter = lightbox.querySelector('.lightbox-counter');
        const link = lightbox.querySelector('.lightbox-link');
        const prevBtn = lightbox.querySelector('.lightbox-prev');
        const nextBtn = lightbox.querySelector('.lightbox-next');

        // 2D grid: each row is a diff group, columns are images within it
        const grid = [...document.querySelectorAll('.diff-images')].map((group) => [
          ...group.querySelectorAll('.lightbox-trigger'),
        ]);

        if (grid.length === 0) return;

        let row = 0;
        let col = 0;

        const wrapCol = (r, c) => ((c % grid[r].length) + grid[r].length) % grid[r].length;
        const wrapRow = (r) => ((r % grid.length) + grid.length) % grid.length;

        const show = (r, c) => {
          row = r;
          col = c;
          const img = grid[row][col].querySelector('img');
          image.src = img.src;
          image.alt = img.alt;
          caption.textContent = img.alt;
          counter.textContent = `${col + 1}\u2009/\u2009${grid[row].length}`;
          link.href = img.src;
        };

        const open = (r, c) => {
          show(r, c);
          lightbox.showModal();
        };

        for (const [r, group] of grid.entries()) {
          for (const [c, trigger] of group.entries()) {
            trigger.addEventListener('click', () => open(r, c));
          }
        }

        prevBtn.addEventListener('click', () => show(row, wrapCol(row, col - 1)));
        nextBtn.addEventListener('click', () => show(row, wrapCol(row, col + 1)));
        lightbox.querySelector('.lightbox-close').addEventListener('click', () => lightbox.close());

        lightbox.addEventListener('keydown', (event) => {
          switch (event.key) {
            case 'ArrowLeft':
              event.preventDefault();
              show(row, wrapCol(row, col - 1));
              break;
            case 'ArrowRight':
              event.preventDefault();
              show(row, wrapCol(row, col + 1));
              break;
            case 'ArrowUp': {
              event.preventDefault();
              const upRow = wrapRow(row - 1);
              show(upRow, Math.min(col, grid[upRow].length - 1));
              break;
            }
            case 'ArrowDown': {
              event.preventDefault();
              const downRow = wrapRow(row + 1);
              show(downRow, Math.min(col, grid[downRow].length - 1));
              break;
            }
          }
        });

        lightbox.addEventListener('click', (event) => {
          if (event.target === lightbox) lightbox.close();
        });
      })();
    </script>
  </body>
</html>
